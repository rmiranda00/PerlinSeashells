float turbulence(point p, float pixelsize, float Time)
{
    /* Ensure that the pixel size is between 0 and 1, not inclusive */
    float pixelsizeClamped = max(0.000001, pixelsize);
    pixelsizeClamped = min(pixelsizeClamped, 0.999999);
    
    /* Execute the turbulence algorithm from "An Image Synthesizer" */
    float t = 0;
    float scale = 1;

    float n = 0.0;

    while (scale > pixelsizeClamped) {
        t += abs(noise("perlin", p/scale, Time) * scale);
        scale /= 2;
    }
    
    return t;
}

shader fire(
    float Time = 1.0,
    float pixelsize = 0.2,
    point Point = P,
    output float Cell = 0.0,
    output color Turbulence = 0.8,
    output color Perlin = 0.8,
    output color UPerlin = 0.8,
    output color Simplex = 0.8,
    output color USimplex = 0.8)
{   
    /* Cell Noise */
    Cell = noise("cell", Point);
    
    /* Perlin 4D Turbulence */
    Turbulence = turbulence(Point, pixelsize, Time);

    /* Perlin 4D Noise */
    Perlin = noise("perlin", Point, Time);

    /* UPerlin 4D Noise */
    UPerlin = noise("uperlin", Point, Time);
    
    /* Simplex 4D Noise */
    Simplex = noise("simplex", Point, Time);
    
    /* USimplex 4D Noise */
    USimplex = noise("usimplex", Point, Time);
    
}


